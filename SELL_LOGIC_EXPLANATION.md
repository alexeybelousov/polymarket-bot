# –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–¥–∞–∂–∏

## –û–±—â–∞—è —Å—Ö–µ–º–∞

–í —Å–∏—Å—Ç–µ–º–µ –µ—Å—Ç—å **—Ç—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è –ø—Ä–æ–¥–∞–∂–∏**:

1. **–û—Ç–º–µ–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞** (`cancelSignal`) - –ø—Ä–æ–¥–∞–∂–∞ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–∏–≥–Ω–∞–ª–∞
2. **–ü—Ä–æ–¥–∞–∂–∞ —Ö–µ–¥–∂–∞** (`sellHedge`) - –ø—Ä–æ–¥–∞–∂–∞ —Ö–µ–¥–∂–∞ –∑–∞—Ä–∞–Ω–µ–µ –∏–ª–∏ –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ
3. **–í—ã–∏–≥—Ä—ã—à —Ä—ã–Ω–∫–∞** (`resolveMarket`) - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–¥–∞–∂–∞ —Ö–µ–¥–∂–∞ –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ

---

## 1. –û–¢–ú–ï–ù–ê –°–ò–ì–ù–ê–õ–ê (`cancelSignal`)

### –ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:
- **–¢—Ä–∏–≥–≥–µ—Ä:** –°–∏–≥–Ω–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω, —Ü–≤–µ—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è, –æ—Å—Ç–∞–ª–æ—Å—å ‚â§20 —Å–µ–∫
- **–£—Å–ª–æ–≤–∏—è:**
  - `sellStrategy === 'signal'` (—Å—Ç—Ä–æ–∫–∞ 1058)
  - `series.currentStep === 1` (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞)
  - `series.signalMarketSlug` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  - `timeToEnd <= 20` (–æ—Å—Ç–∞–ª–æ—Å—å ‚â§20 —Å–µ–∫)
  - `currentColor !== series.signalColor` (—Å–∏–≥–Ω–∞–ª –æ—Ç–º–µ–Ω–∏–ª—Å—è)

### –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–∞–∂–∏ (—Å—Ç—Ä–æ–∫–∏ 806-879):

```
1. –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ –≤—Å–µ–º –ø–æ–∑–∏—Ü–∏—è–º —Å–µ—Ä–∏–∏:
   ‚îî‚îÄ –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'active':

2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏:
   ‚îú‚îÄ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º marketSlug –≤ —Ñ–æ—Ä–º–∞—Ç Polymarket
   ‚îú‚îÄ –í—ã–∑—ã–≤–∞–µ–º polymarket.getSellPrice(polySlug, betOutcome)
   ‚îî‚îÄ –ü–æ–ª—É—á–∞–µ–º sellPrice –∏ sellTokenId

3. –ï—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞:
   ‚îî‚îÄ –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ 'price_error' –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º (continue)
      ‚îî‚îÄ –ü–æ–∑–∏—Ü–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π

4. –†–∞—Å—á–µ—Ç —Å—É–º–º—ã –≤–æ–∑–≤—Ä–∞—Ç–∞ (—Å—Ç—Ä–æ–∫–∏ 836-839):
   ‚îú‚îÄ grossReturn = pos.shares * sellPrice
   ‚îú‚îÄ exitFee = grossReturn * EXIT_FEE_RATE (1.5%)
   ‚îî‚îÄ netReturn = grossReturn - exitFee

5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:
   ‚îú‚îÄ totalReturn += netReturn (–Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –æ–±—â–∏–π –≤–æ–∑–≤—Ä–∞—Ç)
   ‚îú‚îÄ totalLoss += (pos.amount - netReturn) (–Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –ø–æ—Ç–µ—Ä–∏)
   ‚îú‚îÄ pos.status = 'sold' (–ø–æ–º–µ—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞–∫ –ø—Ä–æ–¥–∞–Ω–Ω—É—é)
   ‚îî‚îÄ series.totalCommission += exitFee (—É—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é)

6. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è (—Å—Ç—Ä–æ–∫–∏ 848-852):
   ‚îî‚îÄ –°–æ–±—ã—Ç–∏–µ 'sell' —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
      ‚îú‚îÄ step: pos.step
      ‚îú‚îÄ amount: netReturn
      ‚îî‚îÄ message: "üì§ –ü—Ä–æ–¥–∞–ª Step X: Y shares –ø–æ $Z = $W"

7. –ï—Å–ª–∏ —ç—Ç–æ Step 1 (—Å—Ç—Ä–æ–∫–∏ 854-875):
   ‚îî‚îÄ –ü–æ–ª—É—á–∞–µ–º order book details
      ‚îî‚îÄ –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ 'order_book' —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ bids/asks
```

### –§–∏–Ω–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (—Å—Ç—Ä–æ–∫–∏ 881-904):

```
1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:
   ‚îî‚îÄ stats.currentBalance += totalReturn

2. –†–∞—Å—á–µ—Ç P&L:
   ‚îî‚îÄ pnl = totalReturn - series.totalInvested

3. –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Ä–∏–∏:
   ‚îú‚îÄ series.status = 'cancelled'
   ‚îú‚îÄ series.endedAt = new Date()
   ‚îú‚îÄ series.nextStepBought = false
   ‚îî‚îÄ series.nextMarketSlug = null

4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è 'signal_cancelled'
5. –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ activeSeries
6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

**–í–∞–∂–Ω–æ:** –ü—Ä–æ–¥–∞—é—Ç—Å—è –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–µ—Ä–∏–∏, –Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —à–∞–≥!

---

## 2. –ü–†–û–î–ê–ñ–ê –•–ï–î–ñ–ê (`sellHedge`)

### –ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:

**–°—Ü–µ–Ω–∞—Ä–∏–π A: –ó–∞—Ä–∞–Ω–µ–µ (–∑–∞ 20 —Å–µ–∫ –¥–æ –∫–æ–Ω—Ü–∞)**
- **–¢—Ä–∏–≥–≥–µ—Ä:** –†—ã–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω, —Ü–≤–µ—Ç = betColor (–Ω–∞—à —Ü–≤–µ—Ç), –æ—Å—Ç–∞–ª–æ—Å—å ‚â§20 —Å–µ–∫
- **–£—Å–ª–æ–≤–∏—è:**
  - `sellStrategy === 'signal'` (—Å—Ç—Ä–æ–∫–∞ 1106)
  - `series.nextStepBought === true` (—Ö–µ–¥–∂ –∫—É–ø–ª–µ–Ω)
  - `currentColor === series.betColor` (—Ä—ã–Ω–æ–∫ –Ω–∞—à —Ü–≤–µ—Ç)
  - `timeToEnd <= 20` (–æ—Å—Ç–∞–ª–æ—Å—å ‚â§20 —Å–µ–∫)

**–°—Ü–µ–Ω–∞—Ä–∏–π B: –ü—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ**
- **–¢—Ä–∏–≥–≥–µ—Ä:** –†—ã–Ω–æ–∫ –∑–∞–∫—Ä—ã–ª—Å—è, –º—ã –≤—ã–∏–≥—Ä–∞–ª–∏
- **–£—Å–ª–æ–≤–∏—è:**
  - `won === true`
  - `series.nextStepBought === true` (—Ö–µ–¥–∂ –∫—É–ø–ª–µ–Ω)
- **–í–∞–∂–Ω–æ:** –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –í–°–ï–ì–î–ê, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç `sellStrategy`!

### –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–∞–∂–∏ (—Å—Ç—Ä–æ–∫–∏ 914-1011):

```
1. –ü–æ–∏—Å–∫ –ø–æ–∑–∏—Ü–∏–∏ —Ö–µ–¥–∂–∞:
   ‚îî‚îÄ hedgePosition = positions.find(p => p.step === hedgeStep && p.status === 'active')
   ‚îî‚îÄ –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Üí return (–≤—ã—Ö–æ–¥)

2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏ (—Å—Ç—Ä–æ–∫–∏ 918-949):
   ‚îú‚îÄ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º marketSlug —Ö–µ–¥–∂–∞ –≤ —Ñ–æ—Ä–º–∞—Ç Polymarket
   ‚îú‚îÄ –í—ã–∑—ã–≤–∞–µ–º polymarket.getSellPrice(polySlug, betOutcome)
   ‚îî‚îÄ –ü–æ–ª—É—á–∞–µ–º sellPrice –∏ sellTokenId

3. –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–¥–∞–∂–∞ –∑–∞ 20 —Å–µ–∫ (—Å—Ç—Ä–æ–∫–∏ 934-945):
   ‚îî‚îÄ –ü–æ–ª—É—á–∞–µ–º order book details
      ‚îî‚îÄ –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ 'order_book' –ø–æ–∑–∂–µ

4. –†–∞—Å—á–µ—Ç —Å—É–º–º—ã –≤–æ–∑–≤—Ä–∞—Ç–∞ (—Å—Ç—Ä–æ–∫–∏ 952-962):
   ‚îú‚îÄ –ï—Å–ª–∏ sellPrice –ø–æ–ª—É—á–µ–Ω–∞:
   ‚îÇ  ‚îú‚îÄ grossReturn = hedgePosition.shares * sellPrice
   ‚îÇ  ‚îú‚îÄ exitFee = grossReturn * EXIT_FEE_RATE (1.5%)
   ‚îÇ  ‚îî‚îÄ returnAmount = grossReturn - exitFee
   ‚îî‚îÄ –ï—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞ (fallback):
      ‚îî‚îÄ returnAmount = hedgePosition.amount * (1 - EXIT_FEE_RATE * 2)
         ‚îî‚îÄ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ (—Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (—Å—Ç—Ä–æ–∫–∏ 964-966):
   ‚îî‚îÄ stats.currentBalance += returnAmount

6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 968-975):
   ‚îú‚îÄ hedgePosition.status = 'sold'
   ‚îú‚îÄ series.totalInvested -= hedgePosition.amount (–≤—ã—á–∏—Ç–∞–µ–º –∏–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ!)
   ‚îú‚îÄ series.totalCommission += hedgePosition.amount * EXIT_FEE_RATE
   ‚îú‚îÄ series.nextStepBought = false
   ‚îî‚îÄ series.nextMarketSlug = null

7. –†–∞—Å—á–µ—Ç –ø–æ—Ç–µ—Ä–∏ (—Å—Ç—Ä–æ–∫–∏ 977-980):
   ‚îú‚îÄ loss = hedgePosition.amount - returnAmount
   ‚îî‚îÄ series.hedgeLosses += loss (–Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –ø–æ—Ç–µ—Ä–∏ –æ—Ç —Ö–µ–¥–∂–∞)

8. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è 'sell_hedge' (—Å—Ç—Ä–æ–∫–∏ 985-989)

9. –ï—Å–ª–∏ –µ—Å—Ç—å order book details (—Å—Ç—Ä–æ–∫–∏ 992-1005):
   ‚îî‚îÄ –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ 'order_book'
```

**–í–∞–∂–Ω–æ:** 
- –ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Ö–µ–¥–∂–∞ `totalInvested` –£–ú–ï–ù–¨–®–ê–ï–¢–°–Ø –Ω–∞ —Å—É–º–º—É —Ö–µ–¥–∂–∞
- –ü–æ—Ç–µ—Ä—è –æ—Ç —Ö–µ–¥–∂–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `hedgeLosses`
- –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π P&L –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ

---

## 3. –í–´–ò–ì–†–´–® –†–´–ù–ö–ê (`resolveMarket`)

### –ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:
- **–¢—Ä–∏–≥–≥–µ—Ä:** –†—ã–Ω–æ–∫ –∑–∞–∫—Ä—ã–ª—Å—è, `won === true` (resolvedColor === betColor)

### –ü—Ä–æ—Ü–µ—Å—Å (—Å—Ç—Ä–æ–∫–∏ 1143-1202):

```
1. –ï—Å–ª–∏ —Ö–µ–¥–∂ –±—ã–ª –∫—É–ø–ª–µ–Ω (—Å—Ç—Ä–æ–∫–∏ 1145-1148):
   ‚îî‚îÄ –í–°–ï–ì–î–ê –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è sellHedge(series, null)
      ‚îî‚îÄ null –æ–∑–Ω–∞—á–∞–µ—Ç "–Ω–µ –∑–∞ 20 —Å–µ–∫—É–Ω–¥ –¥–æ –∫–æ–Ω—Ü–∞"
      ‚îî‚îÄ –•–µ–¥–∂ –ø—Ä–æ–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

2. –†–∞—Å—á–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞ (—Å—Ç—Ä–æ–∫–∏ 1150-1157):
   ‚îú‚îÄ –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é (currentPosition)
   ‚îú‚îÄ shares = currentPosition.shares
   ‚îú‚îÄ grossReturn = shares * 1.0 (–∫–∞–∂–¥–∞—è share = $1)
   ‚îú‚îÄ exitFee = grossReturn * EXIT_FEE_RATE (1.5%)
   ‚îî‚îÄ winAmount = grossReturn - exitFee

3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏:
   ‚îî‚îÄ currentPosition.status = 'won'

4. –£—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏:
   ‚îî‚îÄ series.totalCommission += exitFee

5. –†–∞—Å—á–µ—Ç P&L (—Å—Ç—Ä–æ–∫–∏ 1165-1167):
   ‚îú‚îÄ hedgeLosses = series.hedgeLosses || 0
   ‚îî‚îÄ pnl = winAmount - series.totalInvested - hedgeLosses
      ‚îî‚îÄ –í–∞–∂–Ω–æ: —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Ç–µ—Ä–∏ –æ—Ç —Ö–µ–¥–∂–∞!

6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:
   ‚îî‚îÄ stats.currentBalance += winAmount

7. –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Ä–∏–∏:
   ‚îú‚îÄ series.status = 'won'
   ‚îî‚îÄ series.endedAt = new Date()
```

**–í–∞–∂–Ω–æ:** 
- –ü—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ —Ö–µ–¥–∂ –ø—Ä–æ–¥–∞–µ—Ç—Å—è –í–°–ï–ì–î–ê, –¥–∞–∂–µ –µ—Å–ª–∏ `sellStrategy === 'hold'`
- P&L —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ç–µ—Ä–∏ –æ—Ç —Ö–µ–¥–∂–∞ (`hedgeLosses`)
- `totalInvested` —É–∂–µ —É–º–µ–Ω—å—à–µ–Ω –Ω–∞ —Å—É–º–º—É —Ö–µ–¥–∂–∞ (–µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø—Ä–æ–¥–∞–Ω –∑–∞—Ä–∞–Ω–µ–µ)

---

## –§–û–†–ú–£–õ–´ –†–ê–°–ß–ï–¢–ê

### –ü—Ä–æ–¥–∞–∂–∞ –ø–æ–∑–∏—Ü–∏–∏ (cancelSignal, sellHedge):

```
grossReturn = shares * sellPrice
exitFee = grossReturn * EXIT_FEE_RATE  (1.5%)
netReturn = grossReturn - exitFee
```

### –í—ã–∏–≥—Ä—ã—à —Ä—ã–Ω–∫–∞:

```
grossReturn = shares * 1.0  (–∫–∞–∂–¥–∞—è share = $1 –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ)
exitFee = grossReturn * EXIT_FEE_RATE  (1.5%)
winAmount = grossReturn - exitFee
```

### –§–∏–Ω–∞–ª—å–Ω—ã–π P&L –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ:

```
pnl = winAmount - series.totalInvested - hedgeLosses
```

–ì–¥–µ:
- `winAmount` - –≤—ã–∏–≥—Ä—ã—à —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏
- `series.totalInvested` - –æ–±—â–∞—è —Å—É–º–º–∞ –≤–ª–æ–∂–µ–Ω–∏–π (—É–º–µ–Ω—å—à–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ —Ö–µ–¥–∂–∏)
- `hedgeLosses` - –ø–æ—Ç–µ—Ä–∏ –æ—Ç –ø—Ä–æ–¥–∞–∂–∏ —Ö–µ–¥–∂–µ–π

---

## –û–°–û–ë–ï–ù–ù–û–°–¢–ò

### 1. Order Book –¥–ª—è Step 1 –∏ —Ö–µ–¥–∂–∞:
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–∏–≥–Ω–∞–ª–∞ (Step 1) - –ø–æ–ª—É—á–∞–µ–º order book
- –ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Ö–µ–¥–∂–∞ –∑–∞ 20 —Å–µ–∫ - –ø–æ–ª—É—á–∞–µ–º order book
- –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ `'order_book'` –≤ —Ç–∞–π–º–ª–∞–π–Ω

### 2. Fallback –¥–ª—è —Ü–µ–Ω—ã:
- –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏ —Ö–µ–¥–∂–∞:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: `amount * (1 - EXIT_FEE_RATE * 2)`
  - –≠—Ç–æ —Ä–µ–¥–∫–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –Ω–æ –µ—Å—Ç—å –∑–∞—â–∏—Ç–∞

### 3. –£—á–µ—Ç —Ö–µ–¥–∂–∞:
- –ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Ö–µ–¥–∂–∞ `totalInvested` –£–ú–ï–ù–¨–®–ê–ï–¢–°–Ø
- –ü–æ—Ç–µ—Ä—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `hedgeLosses`
- –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π P&L

### 4. –ü—Ä–æ–¥–∞–∂–∞ –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ:
- –•–µ–¥–∂ –ø—Ä–æ–¥–∞–µ—Ç—Å—è –í–°–ï–ì–î–ê –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç `sellStrategy`
- –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ P&L

---

## –ü–†–ò–ú–ï–†–´

### –ü—Ä–∏–º–µ—Ä 1: –û—Ç–º–µ–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞ –Ω–∞ Step 1

```
–ü–æ–∑–∏—Ü–∏—è: Step 1, amount = $2.00, shares = 4.08, price = $0.49
–°–∏–≥–Ω–∞–ª –æ—Ç–º–µ–Ω–∏–ª—Å—è, –ø—Ä–æ–¥–∞–µ–º:

1. –ü–æ–ª—É—á–∞–µ–º sellPrice = $0.48
2. grossReturn = 4.08 * 0.48 = $1.96
3. exitFee = $1.96 * 0.015 = $0.03
4. netReturn = $1.96 - $0.03 = $1.93
5. totalReturn = $1.93
6. totalLoss = $2.00 - $1.93 = $0.07
7. pnl = $1.93 - $2.00 = -$0.07
```

### –ü—Ä–∏–º–µ—Ä 2: –ü—Ä–æ–¥–∞–∂–∞ —Ö–µ–¥–∂–∞ –∑–∞ 20 —Å–µ–∫

```
–•–µ–¥–∂: Step 2, amount = $5.00, shares = 10.05, price = $0.49
–†—ã–Ω–æ–∫ –Ω–∞—à —Ü–≤–µ—Ç, –ø—Ä–æ–¥–∞–µ–º –∑–∞ 20 —Å–µ–∫:

1. –ü–æ–ª—É—á–∞–µ–º sellPrice = $0.50
2. grossReturn = 10.05 * 0.50 = $5.03
3. exitFee = $5.03 * 0.015 = $0.08
4. returnAmount = $5.03 - $0.08 = $4.95
5. loss = $5.00 - $4.95 = $0.05
6. hedgeLosses += $0.05
7. totalInvested -= $5.00 (—Ç–µ–ø–µ—Ä—å $2.00 –≤–º–µ—Å—Ç–æ $7.00)
```

### –ü—Ä–∏–º–µ—Ä 3: –í—ã–∏–≥—Ä—ã—à —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã–º —Ö–µ–¥–∂–µ–º

```
Step 1: amount = $2.00, shares = 4.08
–•–µ–¥–∂ Step 2: –ø—Ä–æ–¥–∞–Ω –∑–∞ $4.95 (–ø–æ—Ç–µ—Ä—è $0.05)

–í—ã–∏–≥—Ä—ã—à Step 1:
1. winAmount = 4.08 * 1.0 - (4.08 * 0.015) = $4.02
2. totalInvested = $2.00 (—Ö–µ–¥–∂ —É–∂–µ –≤—ã—á—Ç–µ–Ω)
3. hedgeLosses = $0.05
4. pnl = $4.02 - $2.00 - $0.05 = $1.97
```

---

## –í–ê–ñ–ù–´–ï –ú–û–ú–ï–ù–¢–´

1. **–ö–æ–º–∏—Å—Å–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã:**
   - –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ: `entryFee = amount * ENTRY_FEE_RATE`
   - –ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ: `exitFee = grossReturn * EXIT_FEE_RATE`

2. **–•–µ–¥–∂ —É–º–µ–Ω—å—à–∞–µ—Ç totalInvested:**
   - –ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Ö–µ–¥–∂–∞ `totalInvested` —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
   - –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ P&L

3. **hedgeLosses –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è:**
   - –ö–∞–∂–¥–∞—è –ø—Ä–æ–¥–∞–∂–∞ —Ö–µ–¥–∂–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ—Ç–µ—Ä—é –≤ `hedgeLosses`
   - –≠—Ç–æ –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ P&L

4. **–ü—Ä–æ–¥–∞–∂–∞ –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞:**
   - –•–µ–¥–∂ –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ
   - –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞

