# Схема логики покупки и продажи

## Параметры стратегии

- **`buyStrategy`**: `'signal'` | `'validated'`
  - `'signal'`: Покупаем сразу по сигналу
  - `'validated'`: Проверяем стабильность перед покупкой (пока не реализовано)

- **`sellStrategy`**: `'signal'` | `'hold'`
  - `'signal'`: Продаем за 20 сек если сигнал изменился (смотрим на цвет сигнала)
  - `'hold'`: Не продаем заранее, держим до конца

---

## 1. ПОКУПКА ПЕРВОЙ СТАВКИ (`onSignal`)

**Триггер:** Получен сигнал для торговли

**Процесс:**
```
1. Создается серия (TradeSeries)
2. Проверка buyStrategy:
   ├─ Если buyStrategy === 'validated'
   │  └─ TODO: Реализовать проверку стабильности
   │     └─ Пока использует fallback на 'signal'
   └─ Если buyStrategy === 'signal'
      └─ Сразу вызывается buyStep(series)
         └─ Покупка первой ставки
```

**Текущее состояние:** `'validated'` не реализован, всегда покупает сразу.

---

## 2. ПОКУПКА ХЕДЖА (`buyNextStepEarly`)

**Триггер:** Рынок активен, цвет = signalColor (рынок идет против нас)

**Условия:**
- `buyStrategy === 'signal'` (строка 1099)
- `!series.nextStepBought` (хедж еще не куплен)
- `series.currentStep < maxSteps` (не последний шаг)
- `currentColor === series.signalColor` (рынок идет против нас)

**Процесс:**
```
1. Проверка buyStrategy:
   ├─ Если buyStrategy === 'signal'
   │  └─ Вызывается buyNextStepEarly(series, context)
   │     ├─ Получаем цену для следующего рынка
   │     ├─ Рассчитываем ставку (динамически)
   │     ├─ Покупаем хедж
   │     └─ Устанавливаем nextStepBought = true
   └─ Если buyStrategy === 'validated'
      └─ Хедж НЕ покупается (логика будет добавлена позже)
```

**Важно:** При `buyStrategy === 'validated'` хедж не покупается заранее.

---

## 3. ОТМЕНА СИГНАЛА (`cancelSignal`)

**Триггер:** Сигнальный рынок еще активен, цвет изменился, осталось ≤20 сек

**Условия:**
- `sellStrategy === 'signal'` (строка 1058)
- `series.currentStep === 1` (только для первого шага)
- `series.signalMarketSlug` существует
- `timeToEnd <= 20` (осталось ≤20 сек)
- `currentColor !== series.signalColor` (сигнал отменился)

**Процесс:**
```
1. Проверка sellStrategy:
   ├─ Если sellStrategy === 'signal'
   │  └─ Вызывается cancelSignal(series, currentColor)
   │     ├─ Продаем все активные позиции
   │     ├─ Рассчитываем P&L
   │     ├─ Закрываем серию (status = 'cancelled')
   │     └─ Удаляем из activeSeries
   └─ Если sellStrategy === 'hold'
      └─ Сигнал НЕ отменяется, серия продолжается
```

**Важно:** При `sellStrategy === 'hold'` сигнал не отменяется, даже если цвет изменился.

---

## 4. ПРОДАЖА ХЕДЖА (`sellHedge`)

**Триггер 1:** Рынок активен, цвет = betColor (наш цвет), осталось ≤20 сек

**Условия:**
- `sellStrategy === 'signal'` (строка 1106)
- `series.nextStepBought === true` (хедж куплен)
- `currentColor === series.betColor` (рынок наш цвет)
- `timeToEnd <= 20` (осталось ≤20 сек)

**Процесс:**
```
1. Проверка sellStrategy:
   ├─ Если sellStrategy === 'signal'
   │  └─ Вызывается sellHedge(series, timeToEnd)
   │     ├─ Получаем цену продажи
   │     ├─ Если timeToEnd <= 20, получаем order book
   │     ├─ Продаем хедж
   │     ├─ Рассчитываем потерю (hedgeLosses)
   │     └─ Устанавливаем nextStepBought = false
   └─ Если sellStrategy === 'hold'
      └─ Хедж НЕ продается заранее
```

**Триггер 2:** Рынок закрылся, мы выиграли

**Условия:**
- Рынок закрылся (`won === true`)
- `series.nextStepBought === true` (хедж куплен)

**Процесс:**
```
1. ВСЕГДА вызывается sellHedge(series, null)
   └─ Независимо от sellStrategy!
   ├─ Продаем хедж
   ├─ Рассчитываем потерю (hedgeLosses)
   └─ Устанавливаем nextStepBought = false
```

**Важно:** При выигрыше хедж продается ВСЕГДА, независимо от `sellStrategy`.

---

## 5. РЕЗОЛВ РЫНКА (`resolveMarket`)

**Триггер:** Рынок закрылся

**Процесс:**
```
1. Если выиграли (won === true):
   ├─ Если nextStepBought === true
   │  └─ ВСЕГДА продаем хедж (независимо от sellStrategy)
   ├─ Рассчитываем выигрыш
   ├─ Обновляем P&L
   └─ Закрываем серию (status = 'won')

2. Если проиграли (won === false):
   ├─ Если nextStepBought === true
   │  └─ Переходим на следующий шаг (хедж уже куплен)
   ├─ Если currentStep >= maxSteps
   │  └─ Серия проиграна, создаем cooldown
   └─ Иначе
      └─ Покупаем следующий шаг (buyStep)
```

---

## ТАБЛИЦА ПОВЕДЕНИЯ

| Сценарий | buyStrategy='signal' | buyStrategy='validated' | sellStrategy='early_exit' | sellStrategy='hold' |
|----------|---------------------|------------------------|---------------------------|---------------------|
| **Покупка первой ставки** | ✅ Сразу | ⚠️ TODO | - | - |
| **Покупка хеджа** | ✅ Сразу при signalColor | ❌ Не покупается | - | - |
| **Отмена сигнала** | - | - | ✅ За 20 сек (если сигнал изменился) | ❌ Не отменяется |
| **Продажа хеджа (за 20 сек)** | - | - | ✅ Если betColor (сигнал подтвердился) | ❌ Не продается |
| **Продажа хеджа (при выигрыше)** | ✅ ВСЕГДА | ✅ ВСЕГДА | ✅ ВСЕГДА | ✅ ВСЕГДА |

---

## ТЕКУЩИЕ ПРОБЛЕМЫ / TODO

1. **`buyStrategy === 'validated'` не реализован:**
   - Нужно добавить логику проверки стабильности перед покупкой
   - Можно использовать логику из `monitor-signal-cancel.js`

2. **`buyStrategy === 'validated'` для хеджа:**
   - Сейчас хедж не покупается при `'validated'`
   - Нужно решить, нужна ли проверка стабильности для хеджа

3. **Проверка стабильности:**
   - Нужно определить, когда именно проверять стабильность
   - За какое время до начала рынка
   - Какие критерии использовать

---

## ВОПРОСЫ ДЛЯ ОБСУЖДЕНИЯ

1. **Когда проверять стабильность при `buyStrategy === 'validated'`?**
   - Сразу после получения сигнала?
   - За определенное время до начала рынка?
   - В течение определенного периода?

2. **Нужна ли проверка стабильности для хеджа?**
   - Или хедж всегда покупается при `buyStrategy === 'signal'`?

3. **Что делать, если проверка стабильности не прошла?**
   - Отменить серию?
   - Подождать и проверить еще раз?
   - Пропустить этот рынок?

