<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polymarket Monitor</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap');
    :root {
      --bg: #0a0a0f; --bg2: #14141c; --bg3: #1c1c28; --border: #2a2a3a;
      --text: #e4e4e7; --text2: #71717a;
      --green: #22c55e; --red: #ef4444; --blue: #3b82f6; --yellow: #eab308; --purple: #a855f7;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'JetBrains Mono', monospace; 
      background: var(--bg); 
      color: var(--text); 
      height: 100vh;
      overflow: hidden;
    }
    
    .monitor-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
    }
    .logo { font-weight: 600; font-size: 18px; }
    .logo span { color: var(--blue); }
    .meta { display: flex; align-items: center; gap: 16px; color: var(--text2); font-size: 14px; }
    .live { display: flex; align-items: center; gap: 8px; }
    .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    a { color: var(--text2); text-decoration: none; }
    a:hover { color: var(--text); }
    
    .filters {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 24px;
    }
    .filter-btn {
      padding: 6px 16px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text2);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'JetBrains Mono', monospace;
    }
    .filter-btn:hover {
      background: var(--bg);
      border-color: var(--blue);
      color: var(--text);
    }
    .filter-btn.active {
      background: var(--blue);
      border-color: var(--blue);
      color: white;
    }
    .filter-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .filter-btn:disabled:hover {
      background: var(--bg3);
      border-color: var(--border);
      color: var(--text2);
    }
    
    
    .markets-wrapper {
      overflow: hidden;
      position: relative;
      height: calc(100vh - 73px);
    }
    
    .time-indicator {
      position: absolute;
      left: 75%;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--red);
      z-index: 100;
      pointer-events: none;
    }
    .time-indicator::after {
      content: 'NOW';
      position: absolute;
      bottom: 0;
      left: 4px;
      font-size: 10px;
      color: var(--red);
      background: var(--bg);
      padding: 2px 4px;
      border-radius: 2px;
    }
    
    .markets-container {
      display: flex;
      gap: 0;
      background: var(--border);
      height: 100%;
      position: relative;
      transition: transform 0.1s linear;
    }
    
    .market-column {
      background: var(--bg2);
      display: flex;
      flex-direction: column;
      position: relative;
      flex: 1;
      min-width: 0;
      border-right: 1px solid var(--border);
    }
    .market-column:last-child {
      border-right: none;
    }
    
    .market-label {
      position: absolute;
      top: 0;
      right: -50px;
      width: 100px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      z-index: 10;
      pointer-events: none;
    }
    .market-column.current {
      background: rgba(59, 130, 246, 0.05);
    }
    .market-column.green-bg {
      background: rgba(34, 197, 94, 0.03);
    }
    .market-column.red-bg {
      background: rgba(239, 68, 68, 0.03);
    }
    
    .market-header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      text-align: center;
      min-height: 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
    }
    .market-slug {
      font-size: 12px;
      color: var(--text2);
      font-family: monospace;
      font-weight: 500;
    }
    .market-status {
      font-size: 20px;
      margin-top: 8px;
    }
    
    .bot-labels {
      position: absolute;
      left: -80px;
      top: 0;
      width: 70px;
      height: 100%;
      display: flex;
      flex-direction: column;
      z-index: 10;
      pointer-events: none;
    }
    .bot-label {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      border-top: 1px solid var(--border);
    }
    .bot-label:first-child {
      border-top: none;
    }
    
    .bot-section {
      flex: 1;
      border-top: 1px solid var(--border);
      min-height: 300px;
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .bot-section.bot2 {
      border-bottom: 1px solid var(--border);
    }
    
    .series-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      overflow: visible;
    }
    
    .series-card {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 4px;
      min-height: 60px;
      display: flex;
      flex-direction: column;
    }
    .series-card.won { border-color: var(--green); background: rgba(34, 197, 94, 0.1); }
    .series-card.lost { border-color: var(--red); background: rgba(239, 68, 68, 0.1); }
    .series-card.active { border-color: var(--blue); background: rgba(59, 130, 246, 0.1); }
    .series-card.cooldown { border-color: var(--text2); background: rgba(113, 113, 122, 0.1); opacity: 0.7; }
    
    .series-header {
      font-size: 10px;
      font-weight: 600;
      color: var(--text);
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .series-events {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 9px;
      padding: 6px 8px;
    }
    
    .series-event {
      padding: 4px 6px;
      border-radius: 2px;
      background: var(--bg2);
      color: var(--text2);
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-size: 10px;
      line-height: 1.4;
    }
    .series-event.buy { background: rgba(249, 115, 22, 0.2); color: #f97316; }
    .series-event.hedge { background: rgba(249, 115, 22, 0.2); color: #f97316; }
    .series-event.win { background: rgba(34, 197, 94, 0.2); color: var(--green); }
    .series-event.loss { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    .series-event.neutral { background: var(--bg2); color: var(--text2); }
    .series-event.orderbook { background: var(--bg2); color: var(--text2); }
    
  </style>
</head>
<body>
  <div class="monitor-container">
    <header>
      <div style="display: flex; align-items: center; gap: 24px;">
        <div class="logo">üìä <span>Polymarket</span> Monitor</div>
        <div class="filters" id="bot-filters">
          <!-- –ö–Ω–æ–ø–∫–∏ –±–æ—Ç–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
      <div class="meta">
        <div class="live"><div class="live-dot"></div><span id="time">‚Äî</span></div>
        <a href="/dashboard">dashboard</a>
        <a href="/logs">logs</a>
      </div>
    </header>
    
    <div class="markets-wrapper">
      <div class="time-indicator"></div>
      <div class="bot-labels" id="bot-labels">
        <!-- –ú–µ—Ç–∫–∏ –±–æ—Ç–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      <div class="markets-container" id="markets-container"></div>
    </div>
  </div>

  <script>
    const MS_PER_MINUTE = 60 * 1000;
    const fmtTime = ts => new Date(ts).toLocaleTimeString('ru', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    
    let markets = [];
    let series = { bot2: [], bot3: [] };
    let allBots = [];
    let marketsStartTime = null; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–≤–∏–∂–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤
    let marketDuration = 15 * 60; // 15 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    let selectedBots = []; // –í—ã–±—Ä–∞–Ω–Ω—ã–µ –±–æ—Ç—ã (–º–∞–∫—Å–∏–º—É–º 2)
    
    function getEventClass(type) {
      if (type === 'series_opened') return 'neutral';
      if (type === 'buy' || type === 'sell') return 'buy';
      if (type === 'hedge_bought' || type === 'sell_hedge') return 'hedge';
      if (type === 'order_book') return 'orderbook';
      if (type.includes('won') || type === 'series_won') return 'win';
      if (type.includes('lost') || type === 'series_lost') return 'loss';
      if (type === 'cooldown_started' || type === 'cooldown_ended') return 'neutral';
      if (type === 'waiting_market' || type === 'market_active' || type === 'signal_cancelled' || type === 'series_cancelled') return 'neutral';
      return 'neutral';
    }
    
    function getSeriesClass(status) {
      if (status === 'won') return 'won';
      if (status === 'lost') return 'lost';
      if (status === 'active') return 'active';
      if (status === 'cooldown') return 'cooldown';
      return '';
    }
    
    function parseMarketSlug(slug) {
      // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞:
      // Polymarket: eth-updown-15m-1768410000
      // Binance: binance-ethusdt-1768410000000 (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)
      
      if (!slug) return null;
      
      // –§–æ—Ä–º–∞—Ç Binance: binance-ethusdt-1768410000000
      if (slug.startsWith('binance-')) {
        const parts = slug.split('-');
        if (parts.length >= 3) {
          const timestampMs = parseInt(parts[parts.length - 1]);
          const timestamp = Math.floor(timestampMs / 1000); // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å–µ–∫—É–Ω–¥—ã
          return { timestamp, slug };
        }
      }
      
      // –§–æ—Ä–º–∞—Ç Polymarket: eth-updown-15m-1768410000
      const parts = slug.split('-');
      if (parts.length >= 4) {
        const timestamp = parseInt(parts[parts.length - 1]);
        return { timestamp, slug };
      }
      
      return null;
    }
    
    function getMarketTime(timestamp) {
      const date = new Date(timestamp * 1000);
      return {
        time: date.toLocaleTimeString('ru', {hour:'2-digit',minute:'2-digit'}),
        full: date.toLocaleString('ru', {hour:'2-digit',minute:'2-digit',second:'2-digit'}),
      };
    }
    
    async function loadBots() {
      try {
        const res = await fetch('/api/trading/bots');
        allBots = await res.json();
        
        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –±–æ—Ç–æ–≤
        const filtersContainer = document.getElementById('bot-filters');
        if (filtersContainer) {
          filtersContainer.innerHTML = '';
          allBots.forEach((bot, index) => {
            const btn = document.createElement('button');
            btn.className = 'filter-btn';
            btn.dataset.botId = bot.botId;
            btn.textContent = bot.name || bot.botId;
            
            // –ü–µ—Ä–≤—ã–µ 2 –±–æ—Ç–∞ –∞–∫—Ç–∏–≤–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (index < 2) {
              btn.classList.add('active');
              selectedBots.push(bot.botId);
            }
            
            // –ï—Å–ª–∏ –±–æ—Ç–æ–≤ –±–æ–ª—å—à–µ 2, –æ—Å—Ç–∞–ª—å–Ω—ã–µ disabled
            if (index >= 2) {
              btn.disabled = true;
            }
            
            btn.addEventListener('click', () => {
              if (btn.disabled) return;
              
              const isActive = btn.classList.contains('active');
              
              if (isActive) {
                // –£–±–∏—Ä–∞–µ–º –±–æ—Ç–∞ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                btn.classList.remove('active');
                selectedBots = selectedBots.filter(id => id !== bot.botId);
              } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –±–æ—Ç–∞, –µ—Å–ª–∏ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç
                if (selectedBots.length < 2) {
                  btn.classList.add('active');
                  selectedBots.push(bot.botId);
                }
              }
              
              // –û–±–Ω–æ–≤–ª—è–µ–º disabled —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
              updateBotFiltersState();
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –±–æ—Ç–æ–≤
              updateBotLabels();
              
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ä—ã–Ω–∫–∏
              loadSeries();
              renderMarkets();
            });
            
            filtersContainer.appendChild(btn);
          });
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –±–æ—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
          updateBotLabels();
        }
      } catch(e) { console.error(e); }
    }
    
    function updateBotFiltersState() {
      document.querySelectorAll('.filter-btn[data-bot-id]').forEach(btn => {
        const botId = btn.dataset.botId;
        const isSelected = selectedBots.includes(botId);
        
        // –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω –∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ 2 –±–æ—Ç–∞, disabled
        if (!isSelected && selectedBots.length >= 2) {
          btn.disabled = true;
        } else {
          btn.disabled = false;
        }
      });
    }
    
    async function loadMarkets() {
      try {
        const res = await fetch('/api/markets/live');
        const data = await res.json();
        
        console.log('[MONITOR] Markets data:', data);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º ETH –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–æ–±–∞ –±–æ—Ç–∞ —Ç–æ—Ä–≥—É—é—Ç ETH)
        const assetData = data.eth || data.btc;
        const defaultAsset = data.eth ? 'eth' : 'btc';
        
        if (!assetData) {
          console.error('[MONITOR] No market data found');
          return;
        }
        
        const currentSlug = assetData.current?.slug;
        console.log(`[MONITOR] ${defaultAsset.toUpperCase()} current slug:`, currentSlug);
        
        if (!currentSlug) {
          console.error(`[MONITOR] No current slug found`);
          return;
        }
        
        const currentMarket = parseMarketSlug(currentSlug);
        console.log('[MONITOR] Parsed market:', currentMarket);
        
        if (!currentMarket) {
          console.error('[MONITOR] Failed to parse market slug');
          return;
        }
        
        // –í—ã—á–∏—Å–ª—è–µ–º 6 —Ä—ã–Ω–∫–æ–≤: –±—É–¥—É—â–∏–π, —Ç–µ–∫—É—â–∏–π, –ø—Ä–µ–¥—ã–¥—É—â–∏–µ 4
        const marketInterval = 15 * 60; // 15 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        const newMarkets = [];
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç slug –∏ –±–∞–∑–æ–≤—ã–π –ø—Ä–µ—Ñ–∏–∫—Å
        const isBinance = currentSlug.startsWith('binance-');
        const assetPair = defaultAsset === 'btc' ? 'btcusdt' : 'ethusdt';
        
        // –ë—É–¥—É—â–∏–π —Ä—ã–Ω–æ–∫ (—Å–ø—Ä–∞–≤–∞)
        const futureTs = currentMarket.timestamp + marketInterval;
        const futureSlug = isBinance
          ? `binance-${assetPair}-${futureTs * 1000}` // Binance –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
          : `${defaultAsset}-updown-15m-${futureTs}`;
        newMarkets.push({
          timestamp: futureTs,
          slug: futureSlug,
          isFuture: true,
        });
        
        // –¢–µ–∫—É—â–∏–π —Ä—ã–Ω–æ–∫
        newMarkets.push({
          timestamp: currentMarket.timestamp,
          slug: currentSlug,
          isCurrent: true,
          color: assetData.current?.color || 'unknown',
        });
        
        // –ü—Ä–µ–¥—ã–¥—É—â–∏–µ 4 —Ä—ã–Ω–∫–∞
        for (let i = 1; i <= 4; i++) {
          const ts = currentMarket.timestamp - (marketInterval * i);
          // –§–æ—Ä–º–∏—Ä—É–µ–º slug –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ
          const slug = isBinance 
            ? `binance-${assetPair}-${ts * 1000}` // Binance –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
            : `${defaultAsset}-updown-15m-${ts}`;
          
          // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –∏–∑ API –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä—ã–Ω–∫–æ–≤
          let pastColor = null;
          if (i === 1 && assetData.prev1) {
            pastColor = assetData.prev1.color;
          } else if (i === 2 && assetData.prev2) {
            pastColor = assetData.prev2.color;
          }
          
          newMarkets.push({
            timestamp: ts,
            slug: slug,
            isPast: true,
            color: pastColor,
          });
        }
        
        // –†–µ–≤–µ—Ä—Å–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –±—É–¥—É—â–∏–π –±—ã–ª —Å–ø—Ä–∞–≤–∞
        markets = newMarkets.reverse();
        
        console.log('[MONITOR] Markets array:', markets);
        
        renderMarkets();
      } catch(e) { 
        console.error('[MONITOR] Error loading markets:', e); 
      }
    }
    
    
    async function loadSeries() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤
        const promises = selectedBots.map(botId => 
          fetch(`/api/trading/series?botId=${botId}&limit=1000`)
        );
        
        const responses = await Promise.all(promises);
        const seriesData = await Promise.all(responses.map(r => r.json()));
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        Object.keys(series).forEach(key => {
          if (key.startsWith('bot')) delete series[key];
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ botId
        selectedBots.forEach((botId, index) => {
          series[botId] = seriesData[index];
          console.log(`[MONITOR] ${botId} series:`, series[botId].length);
        });
        
        renderSeries();
      } catch(e) { 
        console.error('[MONITOR] Error loading series:', e); 
      }
    }
    
    function renderMarkets() {
      const container = document.getElementById('markets-container');
      if (!container) {
        console.error('[MONITOR] Markets container not found');
        return;
      }
      
      container.innerHTML = '';
      
      console.log('[MONITOR] Rendering', markets.length, 'markets');
      
      markets.forEach((market, index) => {
        const col = document.createElement('div');
        col.className = `market-column ${market.isCurrent ? 'current' : ''} ${market.color ? `${market.color}-bg` : ''}`;
        col.dataset.market = market.slug;
        col.dataset.timestamp = market.timestamp;
        
        const timeInfo = getMarketTime(market.timestamp);
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º slug –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        // –î–ª—è binance —Ñ–æ—Ä–º–∞—Ç–∞: binance-btcusdt-1768412700000 -> btc-updown-15m-1768412700
        // –î–ª—è polymarket —Ñ–æ—Ä–º–∞—Ç–∞: btc-updown-15m-1768412700 -> btc-updown-15m-1768412700
        let displaySlug = market.slug;
        if (displaySlug.startsWith('binance-')) {
          // –ò–∑–≤–ª–µ–∫–∞–µ–º asset –∏ timestamp
          const parts = displaySlug.split('-');
          const assetPair = parts[1]; // btcusdt –∏–ª–∏ ethusdt
          const asset = assetPair.substring(0, 3); // btc –∏–ª–∏ eth
          const ms = parseInt(parts[2]);
          const seconds = Math.floor(ms / 1000);
          displaySlug = `${asset}-updown-15m-${seconds}`;
        }
        
        // –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ü–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤
        const botSections = selectedBots.map(botId => 
          `<div class="bot-section ${botId}"></div>`
        ).join('');
        
        col.innerHTML = `
          <div class="market-header">
            <div class="market-slug">${displaySlug}</div>
          </div>
          ${botSections}
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É —Å—Ç–æ–ª–±—Ü–∞–º–∏ (—Å–ø—Ä–∞–≤–∞ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ)
        // –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ 15 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ (—Å–ª–µ–¥—É—é—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª)
        if (index < markets.length - 1) {
          const nextMarket = markets[index + 1];
          const nextTimeInfo = getMarketTime(nextMarket.timestamp);
          const label = document.createElement('div');
          label.className = 'market-label';
          label.textContent = nextTimeInfo.time;
          col.appendChild(label);
        }
        
        container.appendChild(col);
      });
      
      renderSeries();
    }
    
    function updateBotLabels() {
      const labelsContainer = document.getElementById('bot-labels');
      if (labelsContainer) {
        labelsContainer.innerHTML = '';
        selectedBots.forEach(botId => {
          const bot = allBots.find(b => b.botId === botId);
          const label = document.createElement('div');
          label.className = 'bot-label';
          label.textContent = bot ? (bot.name || botId) : botId;
          labelsContainer.appendChild(label);
        });
      }
    }
    
    function renderSeries() {
      if (!markets.length || selectedBots.length === 0) return;
      
      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–µ—Ä–∏–∏ –∏–∑ –≤—Å–µ—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
      document.querySelectorAll('.bot-section').forEach(section => {
        section.innerHTML = '';
      });
      
      // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–µ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–Ω—ã –≤ —Ä–∞–º–∫–∞—Ö 6 —Å—Ç–æ–ª–±—Ü–æ–≤
      const minTimestamp = Math.min(...markets.map(m => m.timestamp));
      const maxTimestamp = Math.max(...markets.map(m => m.timestamp));
      const marketInterval = 15 * 60;
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–µ—Ä–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
      selectedBots.forEach(botId => {
        const botSeries = series[botId] || [];
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–µ—Ä–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—É–±—Ä–∞–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤–∞–ª—é—Ç–µ)
        const visibleSeries = botSeries.filter(s => {
          if (!s.startedAt) return false;
          const startTime = new Date(s.startedAt).getTime() / 1000;
          const endTime = s.endedAt ? new Date(s.endedAt).getTime() / 1000 : Date.now() / 1000;
          return (startTime < maxTimestamp + marketInterval && endTime > minTimestamp - marketInterval);
        });
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        const activeSeries = visibleSeries.filter(s => s.status === 'active');
        const completedSeries = visibleSeries.filter(s => s.status !== 'active');
        const seriesToShow = activeSeries.length > 0 
          ? [...activeSeries, ...completedSeries.slice(-5)]
          : completedSeries.slice(-10);
        
        // –î–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Ä–∏–∏ —Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–æ–ª–±—Ü–∞—Ö
        seriesToShow.forEach(seriesItem => {
          renderSeriesCard(seriesItem, botId);
        });
      });
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –∏ –∫—Ä–∞—Å–∏–º —Ñ–æ–Ω
      updateColumnSignals();
    }
    
    function renderSeriesCard(seriesItem, botId) {
      if (!seriesItem.startedAt) return;
      
      const startTime = new Date(seriesItem.startedAt).getTime() / 1000;
      const endTime = seriesItem.endedAt ? new Date(seriesItem.endedAt).getTime() / 1000 : Date.now() / 1000;
      
      // –ù–∞—Ö–æ–¥–∏–º —Å—Ç–æ–ª–±—Ü—ã, –≥–¥–µ —Å–µ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–∞
      markets.forEach((market, idx) => {
        const marketStart = market.timestamp;
        const marketEnd = market.timestamp + (15 * 60);
        
        // –°–µ—Ä–∏—è –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å —Ä—ã–Ω–∫–æ–º, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å –¥–æ –∫–æ–Ω—Ü–∞ —Ä—ã–Ω–∫–∞ –∏ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞
        const intersects = startTime < marketEnd && endTime > marketStart;
        if (!intersects) return;
        
        // –ù–∞—Ö–æ–¥–∏–º DOM —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–æ–ª–±—Ü–∞
        const colEl = document.querySelector(`[data-timestamp="${market.timestamp}"]`);
        if (!colEl) return;
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–µ–∫—Ü–∏—é –±–æ—Ç–∞ –≤ —ç—Ç–æ–º —Å—Ç–æ–ª–±—Ü–µ
        const botSection = colEl.querySelector(`.bot-section.${botId}`);
        if (!botSection) return;
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
        const columnEvents = (seriesItem.events || []).filter(event => {
          if (!event.timestamp) return false;
          const eventTime = new Date(event.timestamp).getTime() / 1000;
          return eventTime >= marketStart && eventTime < marketEnd;
        });
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
        const card = document.createElement('div');
        card.className = `series-card ${getSeriesClass(seriesItem.status)}`;
        card.dataset.seriesId = seriesItem._id || seriesItem.id;
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü —Å–µ—Ä–∏–∏)
        const isFirstColumn = idx === 0 || !markets.slice(0, idx).some(m => {
          const mStart = m.timestamp;
          const mEnd = m.timestamp + (15 * 60);
          return startTime < mEnd && endTime > mStart;
        });
        
        const statusEmoji = seriesItem.status === 'won' ? '‚úÖ' : seriesItem.status === 'lost' ? '‚ùå' : seriesItem.status === 'active' ? 'üîÑ' : seriesItem.status === 'cooldown' ? '‚è∏Ô∏è' : '‚õî';
        const pnl = seriesItem.totalPnL || 0;
        const pnlText = pnl >= 0 ? `+$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`;
        const stepInfo = seriesItem.status === 'active' ? ` Step ${seriesItem.currentStep || 1}` : '';
        const assetText = seriesItem.asset ? seriesItem.asset.toUpperCase() : '';
        
        if (isFirstColumn) {
          const header = document.createElement('div');
          header.className = 'series-header';
          header.textContent = `${statusEmoji} ${assetText} ${pnlText}${stepInfo}`;
          card.appendChild(header);
        }
        
        // –°–æ–±—ã—Ç–∏—è —ç—Ç–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'series-events';
        
        columnEvents.forEach(event => {
          const eventEl = document.createElement('div');
          eventEl.className = `series-event ${getEventClass(event.type)}`;
          const time = fmtTime(event.timestamp);
          const message = (event.message || event.type).substring(0, 50);
          eventEl.textContent = `${time} ${message}`;
          eventEl.title = `${time}: ${event.message || event.type}`;
          eventsContainer.appendChild(eventEl);
        });
        
        card.appendChild(eventsContainer);
        card.title = `${assetText} ${seriesItem.status} - P&L: ${pnlText}${stepInfo}`;
        botSection.appendChild(card);
      });
    }
    
    function updateColumnSignals() {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å–∏–≥–Ω–∞–ª–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π series_opened
      markets.forEach(market => {
        const colEl = document.querySelector(`[data-timestamp="${market.timestamp}"]`);
        if (!colEl) return;
        
        // –ò—â–µ–º —Å–æ–±—ã—Ç–∏–µ series_opened –¥–ª—è —ç—Ç–æ–≥–æ —Ä—ã–Ω–∫–∞
        let signalColor = null;
        selectedBots.forEach(botId => {
          const botSeries = series[botId] || [];
          botSeries.forEach(s => {
            if (!s.events) return;
            const marketStart = market.timestamp;
            const marketEnd = market.timestamp + (15 * 60);
            
            const signalEvent = s.events.find(event => {
              if (event.type !== 'series_opened') return false;
              if (!event.timestamp) return false;
              const eventTime = new Date(event.timestamp).getTime() / 1000;
              return eventTime >= marketStart && eventTime < marketEnd;
            });
            
            if (signalEvent) {
              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (üü¢ –∏–ª–∏ üî¥)
              if (signalEvent.message && signalEvent.message.includes('üü¢')) {
                signalColor = 'green';
              } else if (signalEvent.message && signalEvent.message.includes('üî¥')) {
                signalColor = 'red';
              }
            }
          });
        });
        
        // –ö—Ä–∞—Å–∏–º —Ñ–æ–Ω —Å—Ç–æ–ª–±—Ü–∞
        if (signalColor) {
          colEl.classList.add(`${signalColor}-bg`);
        }
      });
    }
    
    function updateMarketsPosition() {
      if (markets.length === 0) return;
      
      const now = Date.now() / 1000;
      const currentMarket = markets.find(m => m.isCurrent);
      if (!currentMarket) return;
      
      // –í—ã—á–∏—Å–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ —Å –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ä—ã–Ω–∫–∞
      const elapsed = now - currentMarket.timestamp;
      const progress = Math.min(elapsed / marketDuration, 1); // 0 –¥–æ 1
      
      // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ 75% –æ—Ç —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
      const wrapper = document.querySelector('.markets-wrapper');
      if (!wrapper) return;
      const wrapperWidth = wrapper.offsetWidth;
      const indicatorPosition = wrapperWidth * 0.75;
      
      // –ü–æ–∑–∏—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—á–∞–ª–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–±–µ–∑ —É—á–µ—Ç–∞ transform)
      const currentColIndex = markets.findIndex(m => m.isCurrent);
      const currentCol = document.querySelector(`[data-timestamp="${currentMarket.timestamp}"]`);
      const currentColWidth = currentCol ? currentCol.offsetWidth : wrapperWidth / markets.length;
      const currentColPosition = currentColIndex * currentColWidth;
      
      // –°—Ç–æ–ª–±—Ü—ã –¥–≤–∏–≥–∞—é—Ç—Å—è –í–õ–ï–í–û
      // –õ–∏–Ω–∏—è NOW –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ—á–Ω–æ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ –º–µ–∂–¥—É –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∏ —Ç–µ–∫—É—â–∏–º —Å—Ç–æ–ª–±—Ü–æ–º
      // –í –Ω–∞—á–∞–ª–µ –ø–µ—Ä–∏–æ–¥–∞ (progress=0): –ª–∏–Ω–∏—è –Ω–∞ –ø—Ä–∞–≤–æ–π –≥—Ä–∞–Ω–∏—Ü–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
      // –í –∫–æ–Ω—Ü–µ –ø–µ—Ä–∏–æ–¥–∞ (progress=1): –ª–∏–Ω–∏—è –Ω–∞ –ø—Ä–∞–≤–æ–π –≥—Ä–∞–Ω–∏—Ü–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
      
      // –ü–æ–∑–∏—Ü–∏—è –ø—Ä–∞–≤–æ–π –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ (–Ω–∞ –æ–¥–∏–Ω —Å—Ç–æ–ª–±–µ—Ü –≤–ª–µ–≤–æ)
      const prevColRightEdge = currentColPosition;
      // –ü–æ–∑–∏—Ü–∏—è –ø—Ä–∞–≤–æ–π –≥—Ä–∞–Ω–∏—Ü—ã —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
      const currentColRightEdge = currentColPosition + currentColWidth;
      
      // –ü–æ–∑–∏—Ü–∏—è –ª–∏–Ω–∏–∏ NOW –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–∂–¥—É —ç—Ç–∏–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
      const targetLinePosition = prevColRightEdge + (progress * currentColWidth);
      
      // –°–º–µ—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–∫, —á—Ç–æ–±—ã –ª–∏–Ω–∏—è NOW –±—ã–ª–∞ –Ω–∞ –Ω—É–∂–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
      const targetOffset = indicatorPosition - targetLinePosition;
      
      const container = document.getElementById('markets-container');
      if (container) {
        container.style.transform = `translateX(${targetOffset}px)`;
      }
    }
    
    async function update() {
      await loadMarkets();
      await loadSeries();
      document.getElementById('time').textContent = fmtTime(new Date());
      updateMarketsPosition();
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –±–æ—Ç–æ–≤, –ø–æ—Ç–æ–º –¥–∞–Ω–Ω—ã–µ
    (async () => {
      await loadBots();
      update();
    })();
    setInterval(update, 1000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
    setInterval(updateMarketsPosition, 100); // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 100–º—Å
  </script>
</body>
</html>

