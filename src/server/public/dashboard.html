<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polymarket Trading</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap');
    :root {
      --bg: #0a0a0f; --bg2: #14141c; --bg3: #1c1c28; --border: #2a2a3a;
      --text: #e4e4e7; --text2: #71717a;
      --green: #22c55e; --red: #ef4444; --blue: #3b82f6; --yellow: #eab308; --purple: #a855f7;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: var(--text); min-height: 100vh; padding: 24px; }
    .container { max-width: 800px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .logo { font-weight: 600; font-size: 18px; }
    .logo span { color: var(--blue); }
    .meta { display: flex; align-items: center; gap: 16px; color: var(--text2); font-size: 14px; }
    .live { display: flex; align-items: center; gap: 8px; }
    .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    a { color: var(--text2); text-decoration: none; }
    a:hover { color: var(--text); }

    /* Candles */
    .candles-section { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    .candles-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .candles-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .candles-title { font-weight: 600; }
    .candles-timer { color: var(--yellow); }
    .candles-row { display: flex; align-items: center; justify-content: center; gap: 12px; }
    .candle-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .candle-circle.green { background: rgba(34, 197, 94, 0.2); }
    .candle-circle.red { background: rgba(239, 68, 68, 0.2); }
    .candle-circle.unknown { background: var(--bg3); }

    /* Signals */
    .signals-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
    .signal-box { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 12px; text-align: center; }
    .signal-box.active { border-color: var(--green); background: rgba(34, 197, 94, 0.08); }
    .signal-label { font-size: 11px; color: var(--text2); margin-bottom: 6px; }
    .signal-status { font-size: 20px; }

    /* Stats */
    .stats-section { margin-bottom: 24px; }
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px; }
    .stats-row.filter-row { grid-template-columns: repeat(5, 1fr); }
    .stat-item { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; text-align: center; }
    .stat-item.clickable { cursor: pointer; transition: all 0.2s; }
    .stat-item.clickable:hover { border-color: var(--blue); background: var(--bg3); }
    .stat-item.clickable.active { border-color: var(--blue); background: rgba(59, 130, 246, 0.1); }
    .stat-value { font-size: 18px; font-weight: 600; }
    .stat-value.positive { color: var(--green); }
    .stat-value.negative { color: var(--red); }
    .stat-value.neutral { color: var(--yellow); }
    .stat-label { font-size: 10px; color: var(--text2); margin-top: 4px; }
    .percent-change { font-size: 10px; color: var(--text2); }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 600px) {
      .stats-row:first-of-type {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Series */
    .series-section { margin-bottom: 24px; }
    .series-title { font-size: 14px; color: var(--text2); margin-bottom: 12px; }
    .series-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .series-card.active { border-color: var(--text2); }
    .series-card.won { border-color: var(--green); }
    .series-card.lost { border-color: var(--red); }
    .series-card.cancelled { border-color: var(--yellow); }
    .series-card.cooldown { border-color: var(--text2); opacity: 0.7; }
    .series-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .series-asset { font-weight: 600; font-size: 16px; }
    .series-status { font-size: 12px; padding: 4px 8px; border-radius: 4px; }
    .series-status.active { background: rgba(113, 113, 122, 0.2); color: var(--text2); }
    .series-status.won { background: rgba(34, 197, 94, 0.2); color: var(--green); }
    .series-status.lost { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    .series-status.cancelled { background: rgba(234, 179, 8, 0.2); color: var(--yellow); }
    .series-status.cooldown { background: rgba(113, 113, 122, 0.2); color: var(--text2); }
    .series-info { display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text2); }
    .series-info span { display: flex; align-items: center; gap: 4px; }

    /* Timeline */
    .timeline { border-left: 2px solid var(--border); padding-left: 16px; margin-left: 8px; }
    .timeline-event { position: relative; padding-bottom: 12px; font-size: 12px; }
    .timeline-event:last-child { padding-bottom: 0; }
    .timeline-event::before {
      content: '';
      position: absolute;
      left: -24px;
      top: 0px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--bg3);
      border: 2px solid var(--border);
    }
    .timeline-event.buy::before { background: #f97316; border-color: #f97316; }
    .timeline-event.hedge::before { background: #f97316; border-color: #f97316; }
    .timeline-event.win::before { background: var(--green); border-color: var(--green); }
    .timeline-event.loss::before { background: var(--red); border-color: var(--red); }
    .timeline-event.neutral::before { background: var(--text2); border-color: var(--text2); }
    .timeline-event.orderbook::before { background: var(--text2); border-color: var(--text2); }
    .timeline-time { color: var(--text2); margin-right: 8px; }
    .timeline-msg { color: var(--text); }

    .no-series { text-align: center; color: var(--text2); padding: 40px; background: var(--bg2); border-radius: 12px; border: 1px solid var(--border); }
    
    /* Show more button */
    .show-more-btn { 
      width: 100%; 
      padding: 12px; 
      background: var(--bg2); 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      color: var(--text2); 
      font-family: inherit;
      font-size: 12px;
      cursor: pointer; 
      transition: all 0.2s;
      margin-top: 12px;
    }
    .show-more-btn:hover { background: var(--bg3); color: var(--text); border-color: var(--blue); }
    
    /* Bot description */
    .bot-info { 
      background: var(--bg2); 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      padding: 12px 16px; 
      margin-bottom: 20px; 
      font-size: 12px; 
      color: var(--text2);
    }
    .bot-info strong { color: var(--text); }
    
    /* Period toggle */
    .period-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .period-btn {
      padding: 6px 12px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text2);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .period-btn:hover { border-color: var(--blue); color: var(--text); }
    .period-btn.active { border-color: var(--blue); background: rgba(59, 130, 246, 0.1); color: var(--text); }
    
    .bot-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .bot-btn {
      flex: 1;
      padding: 6px 12px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text2);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .bot-btn:hover { border-color: var(--blue); color: var(--text); }
    .bot-btn.active { border-color: var(--blue); background: rgba(59, 130, 246, 0.1); color: var(--text); }
    
    .stats-toggle-btn {
      margin-left: auto;
      padding: 6px 10px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text2);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stats-toggle-btn:hover { border-color: var(--blue); color: var(--text); }
    .stats-section.hidden {
      display: none;
    }
    #stats-toggle-icon {
      transition: transform 0.2s;
      display: inline-block;
    }
    
    /* View toggle */
    .series-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .view-toggle {
      display: flex;
      gap: 4px;
    }
    .view-btn {
      padding: 4px 10px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text2);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .view-btn:hover { border-color: var(--blue); color: var(--text); }
    .view-btn.active { border-color: var(--blue); background: rgba(59, 130, 246, 0.15); color: var(--text); }
    
    /* Chart */
    .chart-container {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      height: 300px;
    }
    .chart-filter {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
      font-size: 11px;
      color: var(--text2);
    }
    .chart-filter-btn {
      padding: 4px 10px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text2);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .chart-filter-btn:hover { border-color: var(--blue); color: var(--text); }
    .chart-filter-btn.active { border-color: var(--blue); background: rgba(59, 130, 246, 0.15); color: var(--text); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">üìä <span>Polymarket</span></div>
      <div class="meta">
        <div class="live"><div class="live-dot"></div><span id="time">‚Äî</span></div>
        <a href="/monitor">monitor</a>
        <a href="/logs">logs</a>
      </div>
    </header>

    <!-- Candles -->
    <div class="candles-section">
      <div class="candles-card">
        <div class="candles-header"><span class="candles-title">üî∑ ETH</span><span class="candles-timer" id="timer-eth">‚Äî</span></div>
        <div class="candles-row" id="candles-eth"></div>
      </div>
      <div class="candles-card">
        <div class="candles-header"><span class="candles-title">üî∂ BTC</span><span class="candles-timer" id="timer-btc">‚Äî</span></div>
        <div class="candles-row" id="candles-btc"></div>
      </div>
    </div>

    <!-- Signals -->
    <!-- –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
    <div class="signals-grid">
      <div class="signal-box" id="sig-eth-3"><div class="signal-label">ETH 3—Å</div><div class="signal-status">‚Äî</div></div>
      <div class="signal-box" id="sig-eth-2"><div class="signal-label">ETH 2—Å</div><div class="signal-status">‚Äî</div></div>
      <div class="signal-box" id="sig-btc-3"><div class="signal-label">BTC 3—Å</div><div class="signal-status">‚Äî</div></div>
      <div class="signal-box" id="sig-btc-2"><div class="signal-label">BTC 2—Å</div><div class="signal-status">‚Äî</div></div>
    </div>
    -->

    <!-- Bot Selector -->
    <div class="bot-toggle" id="bot-toggle" style="display: none; margin-bottom: 12px;">
      <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
    </div>

    <!-- Stats -->
    <div class="period-toggle">
      <button class="period-btn active" data-period="all" onclick="setPeriod('all')">–í—Å–µ–≥–æ</button>
      <button class="period-btn" data-period="day" onclick="setPeriod('day')">–ó–∞ —Å—É—Ç–∫–∏</button>
      <button class="stats-toggle-btn" onclick="toggleStats()" title="–°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É">
        <span id="stats-toggle-icon">‚ñº</span>
      </button>
    </div>
    <div class="stats-section" id="stats-section">
      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-value" id="stat-balance">$100</div>
          <div class="stat-label">–ë–∞–ª–∞–Ω—Å</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-pnl">$0</div>
          <div class="stat-label">P&L</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-winrate">0%</div>
          <div class="stat-label">Win Rate</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-frozen" style="color: var(--text)">$0</div>
          <div class="stat-label">–¢–æ—Ä–≥—É–µ—Ç—Å—è</div>
        </div>
      </div>
      <div class="stats-row filter-row">
        <div class="stat-item clickable active" data-filter="all" onclick="setFilter('all')">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">üìä –í—Å–µ</div>
        </div>
        <div class="stat-item clickable" data-filter="won" onclick="setFilter('won')">
          <div class="stat-value positive" id="stat-wins">0</div>
          <div class="stat-label">‚úÖ –ü—Ä–æ—Ñ–∏—Ç</div>
        </div>
        <div class="stat-item clickable" data-filter="lost" onclick="setFilter('lost')">
          <div class="stat-value negative" id="stat-losses">0</div>
          <div class="stat-label">‚ùå –£–±—ã—Ç–æ–∫</div>
        </div>
        <div class="stat-item clickable" data-filter="cancelled" onclick="setFilter('cancelled')">
          <div class="stat-value neutral" id="stat-cancelled">0</div>
          <div class="stat-label">‚õî –û—Ç–º–µ–Ω–∞</div>
        </div>
        <div class="stat-item clickable" data-filter="active" onclick="setFilter('active')">
          <div class="stat-value" id="stat-active" style="color: var(--text2)">0</div>
          <div class="stat-label">üîÑ –ê–∫—Ç–∏–≤–Ω—ã–µ</div>
        </div>
      </div>
    </div>

    <!-- Series -->
    <div class="series-section">
      <div class="series-header-row">
        <div class="series-title">üìà –°–µ—Ä–∏–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏</div>
        <div class="view-toggle">
          <button class="view-btn active" data-view="list" onclick="setView('list')">–°–ø–∏—Å–æ–∫</button>
          <button class="view-btn" data-view="chart" onclick="setView('chart')">–ì—Ä–∞—Ñ–∏–∫</button>
        </div>
      </div>
      <div id="series-list">
        <div class="no-series">–ù–µ—Ç —Å–µ—Ä–∏–π —Ç–æ—Ä–≥–æ–≤–ª–∏</div>
      </div>
      <div id="series-chart" class="chart-container" style="display: none;">
        <div class="chart-filter">
          <span>–ü–æ–∫–∞–∑–∞—Ç—å:</span>
          <button class="chart-filter-btn active" data-limit="10" onclick="setChartLimit(10)">10</button>
          <button class="chart-filter-btn" data-limit="20" onclick="setChartLimit(20)">20</button>
          <button class="chart-filter-btn" data-limit="all" onclick="setChartLimit('all')">–í—Å–µ</button>
        </div>
        <canvas id="balanceChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const emoji = c => c === 'green' ? 'üü¢' : c === 'red' ? 'üî¥' : '‚ö™';
    const fmt = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
    const fmtTime = ts => new Date(ts).toLocaleTimeString('ru', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const MS_PER_MINUTE = 60 * 1000;
    
    let currentFilter = 'all';
    let currentPeriod = 'all';
    let currentView = 'list';
    let allSeries = [];
    let showAll = false;
    let balanceChart = null;
    let chartLimit = 10; // –õ–∏–º–∏—Ç —Å–µ—Ä–∏–π –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
    const DEFAULT_LIMIT = 5;
    
    // –ö—ç—à –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    let filteredSeriesCache = null;
    let lastSeriesHash = null;
    let updateStatsTimeout = null;
    let renderChartTimeout = null;
    let isPageVisible = true;
    let lastStatsValues = {}; // –ö—ç—à –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–∏—à–Ω–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π DOM
    let lastChartDataHash = null; // –•–µ—à –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞
    
    // Throttle —Ñ—É–Ω–∫—Ü–∏—è
    function throttle(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Debounce —Ñ—É–Ω–∫—Ü–∏—è
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('visibilitychange', () => {
      isPageVisible = !document.hidden;
    });
    
    // –•–µ—à –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö
    function getSeriesHash(series) {
      if (!series || series.length === 0) return 'empty';
      return series.length + '_' + series[0]._id + '_' + series[series.length - 1]._id;
    }
    
    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(el => {
        el.classList.toggle('active', el.dataset.view === view);
      });
      document.getElementById('series-list').style.display = view === 'list' ? 'block' : 'none';
      document.getElementById('series-chart').style.display = view === 'chart' ? 'block' : 'none';
      if (view === 'chart') {
        renderChart();
      }
    }
    
    function setChartLimit(limit) {
      chartLimit = limit;
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫–Ω–æ–ø–æ–∫
      document.querySelectorAll('.chart-filter-btn').forEach(el => {
        el.classList.toggle('active', el.dataset.limit == limit);
      });
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
      if (currentView === 'chart') {
        renderChart();
      }
    }
    
    function renderChart() {
      // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤
      if (renderChartTimeout) {
        clearTimeout(renderChartTimeout);
      }
      
      // –î–µ–±–∞—É–Ω—Å–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
      renderChartTimeout = setTimeout(() => {
        const filteredSeries = filterSeries(allSeries);
        let completedSeries = filteredSeries.filter(s => s.status !== 'active').sort((a, b) => new Date(a.startedAt) - new Date(b.startedAt));
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–∏–º–∏—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ (–±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–µ—Ä–∏–π)
        if (chartLimit !== 'all' && completedSeries.length > chartLimit) {
          completedSeries = completedSeries.slice(-chartLimit);
        }
        
        if (completedSeries.length === 0) {
          if (balanceChart) {
            balanceChart.destroy();
            balanceChart = null;
            lastChartDataHash = null;
          }
          return;
        }
        
        // –°—Ç—Ä–æ–∏–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
        const initialDeposit = globalStats.initialDeposit || 100;
        let runningBalance = initialDeposit;
        
        const labels = ['–°—Ç–∞—Ä—Ç'];
        const balanceData = [initialDeposit];
        const pointColors = ['#3b82f6'];
        const pointSizes = [3];
        const tooltips = ['–ù–∞—á–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç: $' + initialDeposit];
        
        completedSeries.forEach(s => {
          runningBalance += (s.totalPnL || 0);
          const time = new Date(s.endedAt || s.startedAt).toLocaleTimeString('ru', {hour:'2-digit', minute:'2-digit'});
          labels.push(time);
          balanceData.push(runningBalance);
          
          const color = s.status === 'won' ? '#22c55e' : s.status === 'lost' ? '#ef4444' : '#eab308';
          pointColors.push(color);
          pointSizes.push(3);
          
          const pnl = s.totalPnL >= 0 ? `+$${s.totalPnL.toFixed(2)}` : `-$${Math.abs(s.totalPnL).toFixed(2)}`;
          const statusText = s.status === 'won' ? '–ü—Ä–æ—Ñ–∏—Ç' : s.status === 'lost' ? '–£–±—ã—Ç–æ–∫' : '–û—Ç–º–µ–Ω–∞';
          tooltips.push(`${s.asset.toUpperCase()} ${statusText}: ${pnl}`);
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
        const chartDataHash = JSON.stringify({labels, balanceData, pointColors});
        if (lastChartDataHash === chartDataHash && balanceChart) {
          return; // –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
        }
        lastChartDataHash = chartDataHash;
        
        const ctx = document.getElementById('balanceChart').getContext('2d');
        
        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        if (balanceChart) {
          balanceChart.data.labels = labels;
          balanceChart.data.datasets[0].data = balanceData;
          balanceChart.data.datasets[0].pointBackgroundColor = pointColors;
          balanceChart.data.datasets[0].pointBorderColor = pointColors;
          balanceChart.update('none'); // 'none' –æ—Ç–∫–ª—é—á–∞–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        } else {
          balanceChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: '–ë–∞–ª–∞–Ω—Å',
                data: balanceData,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointBackgroundColor: pointColors,
                pointBorderColor: pointColors,
                pointRadius: pointSizes,
                pointHoverRadius: 5,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (ctx) => tooltips[ctx.dataIndex],
                    afterLabel: (ctx) => `–ë–∞–ª–∞–Ω—Å: $${ctx.raw.toFixed(2)}`
                  }
                }
              },
              scales: {
                x: {
                  grid: { color: 'rgba(255,255,255,0.05)' },
                  ticks: { color: '#71717a', font: { size: 10 } }
                },
                y: {
                  grid: { color: 'rgba(255,255,255,0.05)' },
                  ticks: { 
                    color: '#71717a', 
                    font: { size: 10 },
                    callback: v => '$' + parseFloat(v).toFixed(0)
                  }
                }
              }
            }
          });
        }
      }, 1000); // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ 1 —Å–µ–∫—É–Ω–¥–∞
    }
    
    function setPeriod(period) {
      currentPeriod = period;
      showAll = false;
      filteredSeriesCache = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–µ—Ä–∏–æ–¥–∞
      document.querySelectorAll('.period-btn[data-period]').forEach(el => {
        el.classList.toggle('active', el.dataset.period === period);
      });
      updateStats(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
    }
    
    function toggleStats() {
      const statsSection = document.getElementById('stats-section');
      statsSection.classList.toggle('hidden');
      const icon = document.getElementById('stats-toggle-icon');
      icon.textContent = statsSection.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
    }
    
    function filterByPeriod(series) {
      if (currentPeriod === 'all') return series;
      const dayAgo = Date.now() - 24 * 60 * 60 * 1000;
      return series.filter(s => {
        const endTime = s.endedAt ? new Date(s.endedAt).getTime() : Date.now();
        return endTime > dayAgo;
      });
    }
    
    function filterSeries(series) {
      // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –ø–µ—Ä–∏–æ–¥—É (—Ñ–∏–ª—å—Ç—Ä –ø–æ –≤–∞–ª—é—Ç–µ —É–±—Ä–∞–Ω)
      return filterByPeriod(series);
    }
    
    function setFilter(filter) {
      currentFilter = filter;
      showAll = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–∞
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
      document.querySelectorAll('.filter-row .stat-item').forEach(el => {
        el.classList.toggle('active', el.dataset.filter === filter);
      });
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–µ—Ä–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –µ—Å–ª–∏ –µ—Å—Ç—å)
      const filteredSeries = filteredSeriesCache || filterSeries(allSeries);
      document.getElementById('series-list').innerHTML = renderSeries(filteredSeries);
      // –ì—Ä–∞—Ñ–∏–∫ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø—É ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
    }
    
    function toggleShowAll() {
      showAll = !showAll;
      const filteredSeries = filteredSeriesCache || filterSeries(allSeries);
      document.getElementById('series-list').innerHTML = renderSeries(filteredSeries);
    }

    function renderCandles(id, data) {
      const el = document.getElementById(id);
      const candles = [data.prev2, data.prev1, data.current];
      el.innerHTML = candles.map(c => 
        `<div class="candle-circle ${c.color}">${emoji(c.color)}</div>`
      ).join('');
    }

    function updateSignal(id, data, count) {
      const box = document.getElementById(id);
      const statusEl = box.querySelector('.signal-status');
      const prev = count === 3 ? [data.prev2, data.prev1] : [data.prev1];
      const cur = data.current;
      const colors = [...prev.map(p => p.color), cur.color];
      const allSame = colors.every(c => c === colors[0] && c !== 'unknown');
      box.classList.toggle('active', allSame);
      statusEl.textContent = allSame ? emoji(colors[0]) : '‚Äî';
    }

    function getEventClass(type) {
      if (type === 'series_opened') return 'neutral';
      if (type === 'buy' || type === 'sell') return 'buy';
      if (type === 'hedge_bought' || type === 'sell_hedge') return 'hedge';
      if (type === 'order_book') return 'orderbook';
      if (type.includes('won') || type === 'series_won') return 'win';
      if (type.includes('lost') || type === 'series_lost') return 'loss';
      if (type === 'cooldown_started' || type === 'cooldown_ended') return 'neutral';
      if (type === 'waiting_market' || type === 'market_active' || type === 'signal_cancelled' || type === 'series_cancelled' || type === 'validation_started') return 'neutral';
      return '';
    }

    function renderSeries(series) {
      if (!series || series.length === 0) {
        return '<div class="no-series">–ù–µ—Ç —Å–µ—Ä–∏–π —Ç–æ—Ä–≥–æ–≤–ª–∏</div>';
      }
      
      // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É
      const filtered = currentFilter === 'all' 
        ? series 
        : series.filter(s => s.status === currentFilter);
      
      if (filtered.length === 0) {
        const filterNames = { all: '—Å–µ—Ä–∏–π', won: '–ø—Ä–æ—Ñ–∏—Ç–Ω—ã—Ö', lost: '—É–±—ã—Ç–æ—á–Ω—ã—Ö', cancelled: '–æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö', active: '–∞–∫—Ç–∏–≤–Ω—ã—Ö' };
        return `<div class="no-series">–ù–µ—Ç ${filterNames[currentFilter]} —Å–µ—Ä–∏–π</div>`;
      }
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ—Å–ª–∏ –Ω–µ showAll
      const totalCount = filtered.length;
      const displaySeries = showAll ? filtered : filtered.slice(0, DEFAULT_LIMIT);
      const hasMore = totalCount > DEFAULT_LIMIT;

      const seriesHtml = displaySeries.map(s => {
        const betEmoji = s.betColor === 'green' ? 'üü¢' : 'üî¥';
        // –ù–∞—Ö–æ–¥–∏–º maxSteps –¥–ª—è —ç—Ç–æ–π —Å–µ—Ä–∏–∏ –ø–æ botId
        const bot = allBots.find(b => b.botId === s.botId);
        const maxSteps = bot?.config?.maxSteps || 4; // Fallback –Ω–∞ 4 –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        let statusText = '';
        if (s.status === 'active') {
          statusText = `Step ${s.currentStep}/${maxSteps}`;
        } else if (s.status === 'cooldown') {
          const now = new Date();
          const endedAt = s.endedAt ? new Date(s.endedAt) : null;
          if (endedAt && endedAt > now) {
            const remainingMs = endedAt - now;
            const remainingMin = Math.ceil(remainingMs / MS_PER_MINUTE);
            statusText = `‚è∏Ô∏è Cooldown: ${remainingMin} –º–∏–Ω`;
          } else {
            statusText = '‚è∏Ô∏è Cooldown';
          }
        } else if (s.status === 'won') {
          statusText = '–ü–†–û–§–ò–¢';
        } else if (s.status === 'cancelled') {
          statusText = '–û–¢–ú–ï–ù–ê';
        } else {
          statusText = '–£–ë–´–¢–û–ö';
        }
        const pnlText = s.totalPnL ? (s.totalPnL >= 0 ? `+$${s.totalPnL.toFixed(2)}` : `-$${Math.abs(s.totalPnL).toFixed(2)}`) : '';

        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –≤ timeline –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const events = (s.events || []);
        const maxEvents = 10; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–±—ã—Ç–∏–π
        const timelineEvents = events.length > maxEvents ? events.slice(-maxEvents) : events;
        const timeline = timelineEvents.map(e => {
          const cls = getEventClass(e.type);
          return `<div class="timeline-event ${cls}">
            <span class="timeline-time">${fmtTime(e.timestamp)}</span>
            <span class="timeline-msg">${e.message || e.type}</span>
          </div>`;
        }).join('');
        const moreEventsCount = events.length > maxEvents ? events.length - maxEvents : 0;

        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π ID —Å–µ—Ä–∏–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å _id –∏–ª–∏ id)
        const seriesId = s._id || s.id || '';
        const fullId = seriesId ? seriesId.toString() : '';
        
        const assetText = s.status === 'cooldown' 
          ? `‚è∏Ô∏è Cooldown: ${s.asset.toUpperCase()}`
          : `${s.asset.toUpperCase()} ${betEmoji}`;
        
        return `<div class="series-card ${s.status}">
          <div class="series-header">
            <span class="series-asset">${assetText}${fullId ? ` <span style="opacity: 0.6; font-size: 0.65em; font-family: monospace;">[${fullId}]</span>` : ''}</span>
            <span class="series-status ${s.status}">${statusText}</span>
          </div>
          <div class="series-info">
            <span>üí∞ $${s.totalInvested?.toFixed(2) || '0'}</span>
            ${pnlText ? `<span style="color: ${s.totalPnL >= 0 ? 'var(--green)' : 'var(--red)'}">${pnlText}</span>` : ''}
            ${s.totalCommission ? `<span style="color: var(--text2); font-size: 0.9em;">üí∏ $${s.totalCommission.toFixed(2)}</span>` : ''}
            <span>üïê ${fmtTime(s.startedAt)}</span>
          </div>
          <div class="timeline">${moreEventsCount > 0 ? `<div style="color: var(--text2); font-size: 10px; padding: 4px 0;">... –µ—â–µ ${moreEventsCount} —Å–æ–±—ã—Ç–∏–π</div>` : ''}${timeline}</div>
        </div>`;
      }).join('');
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å –±–æ–ª—å—à–µ —Å–µ—Ä–∏–π
      if (hasMore) {
        const btnText = showAll 
          ? '‚ñ≤ –°–∫—Ä—ã—Ç—å' 
          : `‚ñº –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ (${totalCount})`;
        return seriesHtml + `<button class="show-more-btn" onclick="toggleShowAll()">${btnText}</button>`;
      }
      
      return seriesHtml;
    }

    async function loadMarkets() {
      try {
        const res = await fetch('/api/markets/live');
        const d = await res.json();
        document.getElementById('timer-eth').textContent = fmt(d.eth.timeToEnd);
        document.getElementById('timer-btc').textContent = fmt(d.btc.timeToEnd);
        renderCandles('candles-eth', d.eth);
        renderCandles('candles-btc', d.btc);
        // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
        // updateSignal('sig-eth-3', d.eth, 3);
        // updateSignal('sig-eth-2', d.eth, 2);
        // updateSignal('sig-btc-3', d.btc, 3);
        // updateSignal('sig-btc-2', d.btc, 2);
        document.getElementById('time').textContent = fmtTime(new Date());
      } catch(e) { console.error(e); }
    }

    let globalStats = { initialDeposit: 100, currentBalance: 100 };
    let currentBotId = 'bot1'; // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–æ—Ç
    let allBots = []; // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–æ—Ç–æ–≤
    
    function updateStats(forceRender = false) {
      // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤
      if (updateStatsTimeout && !forceRender) {
        clearTimeout(updateStatsTimeout);
      }
      
      const doUpdate = () => {
        const currentHash = getSeriesHash(allSeries);
        const needsFullRender = forceRender || currentHash !== lastSeriesHash;
        
        // –ö—ç—à–∏—Ä—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–∏–∏
        if (!filteredSeriesCache || needsFullRender) {
          filteredSeriesCache = filterSeries(allSeries);
          lastSeriesHash = currentHash;
        }
        const filteredSeries = filteredSeriesCache;
        
        // Stats - Row 1: –ë–∞–ª–∞–Ω—Å –∏ P&L –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ–º –∏–∑ —Å–µ—Ä–∏–π
        const initialDeposit = globalStats.initialDeposit || 100;
        
        // –í—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ–º –±–∞–ª–∞–Ω—Å –∏ P&L –∏–∑ —Å–µ—Ä–∏–π –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
        let pnl = 0;
        let completedSeries = [];
        let activeSeries = [];
        
        if (currentPeriod === 'all') {
          // P&L "–í—Å–µ–≥–æ" - —Å—á–∏—Ç–∞–µ–º –∏–∑ –≤—Å–µ—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–µ—Ä–∏–π –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ (–∏—Å–∫–ª—é—á–∞–µ–º cooldown)
          completedSeries = allSeries.filter(s => s.status !== 'active' && s.status !== 'cooldown');
          activeSeries = allSeries.filter(s => s.status === 'active' || s.status === 'cooldown');
          pnl = completedSeries.reduce((sum, s) => sum + (s.totalPnL || 0), 0);
        } else {
          // P&L –∑–∞ –ø–µ—Ä–∏–æ–¥ ‚Äî —Å—É–º–º–∞ –∏–∑ —Å–µ—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ó–ê–ö–û–ù–ß–ò–õ–ò–°–¨ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ (–∏—Å–∫–ª—é—á–∞–µ–º cooldown)
          // (–∏—Å–ø–æ–ª—å–∑—É–µ–º endedAt, –∞ –Ω–µ startedAt, –ø–æ—Ç–æ–º—É —á—Ç–æ P&L —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏)
          const dayAgo = Date.now() - 24 * 60 * 60 * 1000;
          completedSeries = allSeries.filter(s => {
            if (s.status === 'active' || s.status === 'cooldown') return false; // –ò—Å–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ cooldown
            const endTime = s.endedAt ? new Date(s.endedAt).getTime() : null;
            return endTime && endTime > dayAgo; // –ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
          });
          // –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ä–∏–∏ –¥–ª—è "–ó–∞ —Å—É—Ç–∫–∏" - –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ cooldown —Å–µ—Ä–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
          activeSeries = allSeries.filter(s => s.status === 'active' || s.status === 'cooldown');
          pnl = completedSeries.reduce((sum, s) => sum + (s.totalPnL || 0), 0);
        }
        
        // –ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ ‚Äî —Å—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ä–∏—è—Ö (–∏—Å–∫–ª—é—á–∞–µ–º cooldown, —É –Ω–∏—Ö –Ω–µ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π)
        const frozen = activeSeries.filter(s => s.status === 'active').reduce((sum, s) => sum + (s.totalInvested || 0), 0);
        
        // –ë–∞–ª–∞–Ω—Å –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–∑ —Å–µ—Ä–∏–π: initialDeposit + P&L - –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
        const displayBalance = initialDeposit + pnl - frozen;
        
        // –ü—Ä–æ—Ü–µ–Ω—Ç –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É –¥–µ–ø–æ–∑–∏—Ç—É
        const percentChange = ((displayBalance - initialDeposit) / initialDeposit) * 100;
        const percentText = percentChange >= 0 
          ? `+${percentChange.toFixed(2)}%` 
          : `${percentChange.toFixed(2)}%`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º DOM —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
        const balanceKey = `balance_${displayBalance.toFixed(2)}_${percentText}`;
        if (lastStatsValues.balance !== balanceKey) {
          const balanceEl = document.getElementById('stat-balance');
          balanceEl.innerHTML = `$${displayBalance.toFixed(2)} <span class="percent-change">(${percentText})</span>`;
          balanceEl.className = 'stat-value ' + (displayBalance >= initialDeposit ? 'positive' : 'negative');
          lastStatsValues.balance = balanceKey;
        }
        
        const pnlKey = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
        if (lastStatsValues.pnl !== pnlKey) {
          const pnlEl = document.getElementById('stat-pnl');
          pnlEl.textContent = pnlKey;
          pnlEl.className = 'stat-value ' + (pnl >= 0 ? 'positive' : 'negative');
          lastStatsValues.pnl = pnlKey;
        }
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ–º –∏–∑ —Å–µ—Ä–∏–π
        let seriesForStats;
        if (currentPeriod === 'all') {
          // –î–ª—è "–í—Å–µ–≥–æ" –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ —Å–µ—Ä–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
          seriesForStats = allSeries;
        } else {
          // –î–ª—è "–ó–∞ —Å—É—Ç–∫–∏" –∏—Å–ø–æ–ª—å–∑—É–µ–º filteredSeries (—É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –ø–æ –ø–µ—Ä–∏–æ–¥—É)
          seriesForStats = filteredSeries;
        }
        
        const wonSeries = seriesForStats.filter(s => s.status === 'won');
        const lostSeries = seriesForStats.filter(s => s.status === 'lost');
        const cancelledSeries = seriesForStats.filter(s => s.status === 'cancelled');
        const totalCount = seriesForStats.length;
        const wonCount = wonSeries.length;
        const lostCount = lostSeries.length;
        const cancelledCount = cancelledSeries.length;
        const winLossSeries = wonCount + lostCount;
        const winRate = winLossSeries > 0 ? ((wonCount / winLossSeries) * 100).toFixed(0) : 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
        if (lastStatsValues.winrate !== winRate) {
          document.getElementById('stat-winrate').textContent = `${winRate}%`;
          lastStatsValues.winrate = winRate;
        }
        const frozenKey = frozen.toFixed(2);
        if (lastStatsValues.frozen !== frozenKey) {
          document.getElementById('stat-frozen').textContent = `$${frozenKey}`;
          lastStatsValues.frozen = frozenKey;
        }
        
        // Stats - Row 2 (—Ñ–∏–ª—å—Ç—Ä—ã) - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
        const statsKey = `${totalCount}_${wonCount}_${lostCount}_${cancelledCount}_${activeSeries.length}`;
        if (lastStatsValues.counts !== statsKey) {
          document.getElementById('stat-total').textContent = totalCount;
          document.getElementById('stat-wins').textContent = wonCount;
          document.getElementById('stat-losses').textContent = lostCount;
          document.getElementById('stat-cancelled').textContent = cancelledCount;
          document.getElementById('stat-active').textContent = activeSeries.length;
          lastStatsValues.counts = statsKey;
        }
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–µ—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏ –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
        if (currentView === 'list' && needsFullRender) {
          document.getElementById('series-list').innerHTML = renderSeries(filteredSeries);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω
        if (currentView === 'chart') {
          renderChart();
        }
      };
      
      if (forceRender) {
        doUpdate();
      } else {
        updateStatsTimeout = setTimeout(doUpdate, 1000); // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ 1 —Å–µ–∫—É–Ω–¥–∞
      }
    }
    
    async function loadBots() {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–æ—Ç–æ–≤ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      if (allBots.length > 0) return;
      
      try {
        const res = await fetch('/api/trading/bots');
        allBots = await res.json();
        
        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è
        const toggleEl = document.getElementById('bot-toggle');
        if (toggleEl) {
          toggleEl.innerHTML = '';
          allBots.forEach(bot => {
            const btn = document.createElement('button');
            btn.className = `bot-btn ${bot.botId === currentBotId ? 'active' : ''}`;
            btn.textContent = bot.name;
            btn.dataset.botId = bot.botId;
            btn.onclick = () => selectBot(bot.botId);
            toggleEl.appendChild(btn);
          });
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å, –µ—Å–ª–∏ –±–æ—Ç–æ–≤ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ
          toggleEl.style.display = allBots.length > 1 ? 'flex' : 'none';
        }
      } catch(e) { console.error(e); }
    }
    
    function selectBot(botId) {
      if (!botId) return;
      currentBotId = botId;
      filteredSeriesCache = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à –ø—Ä–∏ —Å–º–µ–Ω–µ –±–æ—Ç–∞
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
      document.querySelectorAll('.bot-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.botId === botId);
      });
      
      loadTrading(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
    }

    async function loadTrading() {
      // –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –≤–∏–¥–Ω–∞
      if (!isPageVisible) return;
      
      try {
        const [statsRes, seriesRes] = await Promise.all([
          fetch(`/api/trading/stats?botId=${currentBotId}`),
          fetch(`/api/trading/series?limit=500&botId=${currentBotId}`), // –£–º–µ–Ω—å—à–∏–ª–∏ –ª–∏–º–∏—Ç —Å 1000 –¥–æ 500
        ]);
        globalStats = await statsRes.json();
        const newSeries = await seriesRes.json();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
        const newHash = getSeriesHash(newSeries);
        if (newHash !== lastSeriesHash) {
          allSeries = newSeries;
          filteredSeriesCache = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à –ø—Ä–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          updateStats(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        } else {
          // –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ —Å–µ—Ä–∏–π
          updateStats(false);
        }
      } catch(e) { console.error(e); }
    }

    loadBots();
    loadMarkets();
    loadTrading();
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤–∏–¥–∏–º–æ—Å—Ç–∏
    setInterval(() => {
      if (isPageVisible) loadMarkets();
    }, 5000); // –£–≤–µ–ª–∏—á–∏–ª–∏ —Å 3 –¥–æ 5 —Å–µ–∫—É–Ω–¥
    
    setInterval(() => {
      if (isPageVisible) loadTrading();
    }, 5000); // –£–≤–µ–ª–∏—á–∏–ª–∏ —Å 3 –¥–æ 5 —Å–µ–∫—É–Ω–¥
  </script>
</body>
</html>